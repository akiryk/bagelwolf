---
import { ViewTransitions } from 'astro:transitions';
import SEO from '../components/SEO.astro';
import '../styles/global.css';
import { getCollection } from 'astro:content';
import MobileMenuScript from '../components/scripts/MobileMenuScript.js';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  type?: 'website' | 'article';
  noindex?: boolean;
}

const {
  title = 'Bagelwolf Bakery',
  description = 'Handrolled sourdough bagels and artisan breads baked fresh in Durango, Colorado. Made with a homemade starter, traditional techniques, and 24-hour cold fermentation.',
  image,
  type,
  noindex,
} = Astro.props;
const currentPath = Astro.url.pathname;

const navLinks = [
  { href: '/bagels', label: 'BAGELS' },
  { href: '/bread', label: 'BREADS' },
  { href: '/about', label: 'ABOUT' },
];

const orderButtonEntries = await getCollection('order-button');
const orderButton = orderButtonEntries[0];
const { text: orderButtonText, url: orderButtonUrl } = orderButton.data;

const siteSettingsEntries = await getCollection('site-settings');
const siteSettings = siteSettingsEntries[0];
const { tagline, locationText } = siteSettings.data;

function isActive(href: string): boolean {
  if (href === '/') {
    return currentPath === '/';
  }
  return currentPath.startsWith(href);
}

function navLinkClasses(href: string, size: 'sm' | '2xl' = 'sm'): string {
  const base = `text-${size} tracking-wider transition-colors`;
  return isActive(href)
    ? `${base} font-bold text-stone-900`
    : `${base} text-stone-600 hover:text-stone-900`;
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <SEO
      title={title}
      description={description}
      image={image}
      type={type}
      noindex={noindex}
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;700&family=Spectral:wght@200;300&display=swap"
      rel="stylesheet"
    />
    <ViewTransitions />
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0ZT1PZ1PR7"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', 'G-0ZT1PZ1PR7');
    </script>
    <!-- Microsoft Clarity -->
    <script>
      (function (c, l, a, r, i, t, y) {
        c[a] =
          c[a] ||
          function () {
            (c[a].q = c[a].q || []).push(arguments);
          };
        t = l.createElement(r);
        t.async = 1;
        t.src = 'https://www.clarity.ms/tag/' + i;
        y = l.getElementsByTagName(r)[0];
        y.parentNode.insertBefore(t, y);
      })(window, document, 'clarity', 'script', 'ujyyq6cqdg');
    </script>

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#db5009" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta name="msapplication-TileColor" content="#db5009" />
    <meta name="theme-color" content="#ffffff" />
  </head>
  <body class="min-h-screen flex flex-col bg-white text-stone-800 font-sans">
    <header class="bg-white relative">
      <!-- Mobile hamburger menu button - fixed in upper left -->
      <button
        id="mobile-menu-button"
        class="md:hidden absolute top-4 left-4 p-2 text-brand hover:text-brand-dark transition-colors z-10"
        aria-label="Open menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>

      <!-- Centered Logo -->
      <div class="text-center mb-6 mt-6 mx-6" data-astro-transition-persist>
        <a href="/" class="inline-block">
          <div class="mx-auto mb-4 max-w-xs aspect-[1182/980]">
            <video
              id="logo-video"
              autoplay
              muted
              playsinline
              preload="auto"
              class="w-full h-full object-contain"
            >
              <source src="/video/animation-3-step.webm" type="video/webm" />
              <source src="/video/animation-3-step.mp4" type="video/mp4" />
            </video>
          </div>
        </a>

        <p class="font-serif text-warm-brown text-md tracking-wide">
          {tagline}
        </p>

        <p
          class="md:hidden font-serif text-warm-brown text-xs tracking-widest uppercase mt-4"
        >
          {locationText}
        </p>
      </div>

      <!-- Navigation Bar - desktop only -->
      <nav class="hidden md:block border-t border-b border-stone-200">
        <!-- Desktop nav with true center alignment, respects grid margins -->
        <div
          class="grid grid-cols-3 items-center mx-auto py-3 px-[var(--grid-margin)]"
        >
          <!-- Left: navigation links -->
          <ul class="flex gap-8 justify-self-start">
            {
              navLinks.map((link) => (
                <li>
                  <a
                    href={link.href}
                    class={navLinkClasses(link.href)}
                    aria-current={isActive(link.href) ? 'page' : undefined}
                  >
                    {link.label}
                  </a>
                </li>
              ))
            }
          </ul>

          <!-- Center: location text (truly centered) -->
          <p
            class="font-serif text-warm-brown text-xs tracking-widest uppercase justify-self-center"
          >
            {locationText}
          </p>

          <!-- Right: order button -->
          <a
            href={orderButtonUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="justify-self-end px-5 py-2 bg-brand text-white text-sm font-medium tracking-wider rounded hover:bg-brand-dark transition-colors focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-2"
          >
            {orderButtonText}
          </a>
        </div>
      </nav>

      <!-- Mobile menu overlay -->
      <div
        id="mobile-menu"
        class="fixed inset-0 bg-white z-50 hidden flex-col"
        aria-hidden="true"
      >
        <div class="flex justify-start p-4">
          <button
            id="mobile-menu-close"
            class="p-2 text-stone-600 hover:text-stone-900 transition-colors"
            aria-label="Close menu"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <nav class="flex-1 flex flex-col items-center justify-center gap-8">
          {
            navLinks.map((link) => (
              <a
                href={link.href}
                class={navLinkClasses(link.href, '2xl')}
                aria-current={isActive(link.href) ? 'page' : undefined}
              >
                {link.label}
              </a>
            ))
          }
          <a
            href={orderButtonUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="mt-4 px-8 py-3 bg-brand text-white text-lg font-medium tracking-wider rounded hover:bg-brand-dark transition-colors"
          >
            {orderButtonText}
          </a>
        </nav>
      </div>

      <!-- Mobile menu script -->
      <Fragment set:html={MobileMenuScript} />
    </header>

    <main id="main-content" class="flex-1">
      <slot />
    </main>

    <footer
      class="flex flex-col text-stone-700 md:h-[380px]
  bg-[#ebe5df]
  md:bg-[url('/images/footer-puppy.png')]
  md:bg-left-top
  md:bg-no-repeat
  md:bg-[length:280px_auto]
  lg:bg-[length:350px_auto]
  xl:bg-[length:420px_auto]"
    >
      <!-- Main content - near top -->
      <div class="grid-container pt-8 md:pt-12">
        <!-- Stacked layout with centered puppy (below 840px) -->
        <div class="md:hidden flex flex-col items-center text-center">
          <div class="mb-6">
            <h2 class="font-serif text-xl text-stone-900 mb-2">BagelWolf</h2>
            <p class="text-stone-600">Durango, Colorado</p>
          </div>
          <div class="mb-6">
            <h2 class="font-serif text-xl text-stone-900 mb-2">Contact</h2>
            <p class="text-stone-600">
              <a
                href="mailto:bagelwolfbakery@gmail.com"
                class="hover:text-stone-900 transition-colors"
              >
                bagelwolfbakery@gmail.com
              </a>
            </p>
            <p class="text-stone-600 mt-1">
              <a
                href="https://instagram.com/bagelwolfbakery"
                target="_blank"
                rel="noopener noreferrer"
                class="hover:text-stone-900 transition-colors"
              >
                @bagelwolfbakery
              </a>
            </p>
          </div>
          <!-- Centered puppy image -->
          <img
            src="/images/puppy-and-bagel.png"
            alt="Jojo the puppy with a bagel"
            class="w-[150px] h-auto mb-4"
          />
        </div>

        <!-- Desktop: grid layout (840px+) -->
        <div class="hidden md:block">
          <div class="grid-9">
            <!-- Brand & Location -->
            <div class="col-span-2 col-start-4">
              <h2 class="font-serif text-xl text-stone-900 mb-2">BagelWolf</h2>
              <p class="text-stone-600">Durango, Colorado</p>
            </div>

            <!-- Contact -->
            <div class="col-span-2 col-start-6">
              <h2 class="font-serif text-xl text-stone-900 mb-2">Contact</h2>
              <p class="text-stone-600">
                <a
                  href="mailto:bagelwolfbakery@gmail.com"
                  class="hover:text-stone-900 transition-colors"
                >
                  bagelwolfbakery@gmail.com
                </a>
              </p>
              <p class="text-stone-600 mt-1">
                <a
                  href="https://instagram.com/bagelwolfbakery"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="hover:text-stone-900 transition-colors"
                >
                  @bagelwolfbakery
                </a>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Copyright - locked to bottom -->
      <div class="grid-container mt-auto pb-6">
        <div class="pt-6 border-t border-stone-400">
          <p class="text-stone-500 text-sm text-center">
            &copy; {new Date().getFullYear()} BagelWolf. All rights reserved.
          </p>
        </div>
      </div>
    </footer>
  </body>
</html>
